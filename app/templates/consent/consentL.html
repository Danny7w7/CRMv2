<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consent Form</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .rights-section {
            background-color: #7e7e7e;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .signature-pad {
            border: 2px solid #ffffff;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .roboto-light {
            font-family: "Roboto", sans-serif;
            font-weight: 300;
            font-style: normal;
        }
        .roboto-medium {
            font-family: "Roboto", sans-serif;
            font-weight: 500;
            font-style: normal;
        }
        .roboto-black {
            font-family: "Roboto", sans-serif;
            font-weight: 900;
            font-style: normal;
        }
        .color-blue{
            color: #000000;
        }
        body {
            background-color: #1565c0;
            padding: 20px;
        }
        .bg-orange{
            background-color: #fc700C;
        }
        .bg-lila{
            background-color: #99ff00;
        }
        .bg-morado{
            background-color: #8d4aff;
        }
        .bg-rosa{
            background-color: #ff94bc;
        }
        canvas {
            border: 2px solid red;
            border-radius: 8px;
            background: #fff;
            touch-action: none;
        }
        .floating-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .copy-button {
            background-color: #00ff08;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .copy-button:hover {
            background-color: #48aa4d;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .copy-button:active {
            transform: translateY(0);
        }
        .success-message {
            color: #00ff08;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .input-verde-sombra {
            border: 2px solid rgb(0, 255, 0);
            color: rgb(0, 255, 0);
            box-shadow: 0 0 8px rgb(22, 107, 1);
        }
        .custom-link {
            color: black;
        }
        .custom-link:hover {
            color: red;
        }
    </style>
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="form-container roboto-medium color-blue">
        <h2 class="text-center mb-4 roboto-black color-blue">AGENTE EN REGISTRO</h2>
        <h6 class="text-center mb-4 roboto-medium color-blue container">AUTORIZACION DE ENTREGA INFORMACIÓN PARA ENROLAMIENTO EN EL MERCADO DE SALUD</h6>
        {% csrf_token %}
        <meta name="csrf-token" content="{{ csrf_token }}">

        <form id="signatureForm" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <!-- Personal Information -->
            <div class="bg-orange p-3 rounded mb-3">
                <label class="form-label">Nombre del Aplicante<span class="text-danger">*</span></label>
                <div class="row g-2">
                    <div class="col">
                        <input id="inputName" name="first_name" type="text" class="form-control" required placeholder="Nombre">
                    </div>
                    <div class="col">
                        <input id="inputLastName" name="last_name" type="text" class="form-control" required placeholder="Apellido">
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="bg-info p-3 rounded">
                        <label class="form-label">Teléfono<span class="text-danger">*</span></label>
                        <input id="inputPhone" name="phone_number" type="number" class="form-control" required>
                        <p id="error" style="color: red; display: none;">Número no válido. Debe ser un número de 10 o 11 dígitos.</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="bg-lila p-3 rounded">
                        <label class="form-label">Email</label>
                        <input id="inputEmail" name="email" type="email" class="form-control">
                        <p id="errorEmail" style="color: red; display: none;">Email no valido.</p>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col">
                    <div class="bg-morado p-3 rounded">
                        <label class="form-label">Acepto a ser contactado por mi broker, mi carrier, y/o el mercado de salud vía:</label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input id="Telefono" class="form-check-input contactMethod" type="checkbox" name="phone" />
                                    <label class="form-check-label" for="">Telefono</label>
                                </div>
                                <div class="form-check">
                                    <input id="Sms" class="form-check-input contactMethod" type="checkbox" name="sms" />
                                    <label class="form-check-label" for="">Mensajes de Texto</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input id="Emails" class="form-check-input contactMethod" type="checkbox" name="emails" />
                                    <label class="form-check-label" for="">Email</label>
                                </div>
                                <div class="form-check">
                                    <input id="Whatsapp" class="form-check-input contactMethod" type="checkbox" name="whatsapp" />
                                    <label class="form-check-label" for="">Whatsapp</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="bg-warning p-3 rounded">
                        <label class="form-label">Aplica<span class="text-danger">*</span></label>
                        <select name="apply" class="form-select" id="apply">
                            <option disabled value="no_valid" selected>Please Select</option>
                            <option value="True">SI</option>
                            <option value="False">NO</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <div class="bg-morado p-3 rounded">
                        <label class="form-label">Aplicante (s) Adicional (es) (Nombre Completo, Fecha Nacimiento, Sexo, Status, Parentesco, Aplica)</label>
                        <div class="mb-3">
                            <textarea class="form-control" name="applicants" id="inputApplicants" rows="5"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="bg-warning p-3 rounded">
                        <label class="form-label">Direccion<span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <input id="inputAddress" name="address" class="form-control">
                                <small>Direccion</small>
                            </div>
                            <div class="col-12 mb-3">
                                <input id="inputApto" class="form-control">
                                <small>Apto</small>
                            </div>
                            <div class="col-6 mb-3">
                                <input id="inputCity" class="form-control">
                                <small>Ciudad</small>
                            </div>
                            <div class="col-6 mb-3">
                                <input id="inputState" class="form-control">
                                <small>Estado</small>
                            </div>
                            <div class="col-12">
                                <input id="inputZipcode" name="zipcode" class="form-control">
                                <small>ZipCode</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-12 bg-rosa p-3 rounded mb-3">
                            <label class="form-label">Fecha de Nacimiento <span class="text-danger">*</span></label>
                            <input id="inputDateBirth" name="date_birth" type="date" class="form-control" />
                        </div>
                        <div class="col-12 bg-orange p-3 rounded mb-3">
                            <label class="form-label">Ingreso Anual Estimado <span class="text-danger">*</span></label>
                            <input id="inputTaxes" name="taxes" type="number" class="form-control" />
                        </div>
                        <div class="col-12 bg-info p-3 rounded">
                            <label class="form-label">Tipo de Ingreso <span class="text-danger">*</span></label>
                            <select id="work" name="work" class="form-select">
                                <option value="no_valid">Please Select</option>
                                <option value="W2">W2</option>
                                <option value="1099">1099</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="p-3 rounded" style="background-color: #48ff00;">
                        <label class="form-label">Estatus de Inmigración <span class="text-danger">*</span></label>
                        <select id="migration_status" name="migration_status" class="form-select">
                            <option value="no_valid" disabled selected>Please Select</option>
                            <option value="EMPLOYMENT AUTHORIZATION">Employment Authorization</option>
                            <option value="NOTICE OF ACTION">Notice of Action (i-797)</option>
                            <option value="REFUGEE">Refugee</option>
                            <option value="ASYLUM">Asylum</option>
                            <option value="TPS">Temporary Protection Status (TPS)</option>
                            <option value="DOMESTIC VIOLENCE">Domestic Violence</option>
                            <option value="PERMANENT RESIDENT">Permanent Resident (Green Card)</option>
                            <option value="CONDITIONAL RESIDENT">Conditional Resident</option>
                            <option value="PAROLE">Parole</option>
                            <option value="US CITIZEN">US Citizen (Driver's License)</option>
                            <option value="STUDENT VISA">Student Visa (I-20)</option>
                            <option value="CURRENTLY IN PROCESS">Currently In Process (this means the client received an i-797)</option>
                        </select>
                    </div>
                </div>
                <div class="p-3 rounded col-md-6" style="background-color: #5d00ff;">
                    <label class="form-label">Social Security <span class="text-danger">*</span></label>
                    <input id="inputSSN" class="form-control">
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="p-3 rounded" style="background-color: #ff5e00;">
                        <label class="form-label">Agente Autorizado de Registro<span class="text-danger">*</span></label>
                        <select name="agent_usa" id="selectAgent" class="form-select">
                            <option value="no_valid">Please Select</option>
                            <option value="GINA PAOLA LAPEIRA - NPN 19944280">GINA PAOLA LAPEIRA - NPN 19944280</option>
                            <option value="LUIS EDUARDO LAPEIRA - NPN 20556081">LUIS EDUARDO LAPEIRA - NPN 20556081</option>
                            <option value="DANIEL SANTIAGO LAPEIRA ACEVEDO - NPN 19904958">DANIEL SANTIAGO LAPEIRA ACEVEDO - NPN 19904958</option>
                            <option value="ZOHIRA RAQUEL DUARTE AGUILAR - NPN 19582295">ZOHIRA RAQUEL DUARTE AGUILAR - NPN 19582295</option>
                            <option value="DANIESKA LOPEZ SEQUEIRA - NPN 20134539">DANIESKA LOPEZ SEQUEIRA - NPN 20134539</option>
                            <option value="VLADIMIR DE LA HOZ FONTALVO - NPN 19915005">VLADIMIR DE LA HOZ FONTALVO - NPN 19915005</option>
                            <option value="FRANK JOSE LOPEZ SEQUEIRA - NPN 21226603">FRANK JOSE LOPEZ SEQUEIRA - NPN 21226603</option>
                            <option value="BORJA G CANTON HERRERA - NPN 20673324">BORJA G CANTON HERRERA - NPN 20673324</option>
                            <option value="RODRIGO G CANTON - NPN 20670005">RODRIGO G CANTON - NPN 20670005</option>
                            <option value="EVELYN BEATRIZ HERRERA - NPN 20671818">EVELYN BEATRIZ HERRERA - NPN 20671818</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="p-3 rounded mb-3" style="background-color: #ff5e00;">
                <label class="form-label">
                    Cargar documento de inmigración, SSN, ID, foto selfie con ID en mano
                </label>
                <div class="border rounded bg-light text-center p-4" style="border: 2px dashed #ddd;" id="dropzone">
                    <div class="mb-2">
                        <i class="bi bi-cloud-upload" style="font-size: 2rem;"></i>
                    </div>
                    <p class="roboto-medium">Subir Archivo o Foto (Frente y Atrás)</p>
                    <small class="text-muted">Drag and drop files here</small>
                    <input name="documents" type="file" id="fileInput" accept="image/*" multiple />
                </div>
                <ul class="list-group mt-3" id="fileList"></ul>
            </div>

            <!-- Rights Section -->
            <div class="rights-section mb-3">
                <div class="rights-section">
                    <h5 class="mb-3 roboto-black">Mis Derechos como Paciente</h5>
                    <p class="roboto-light">Yo, <span id="textName" class="roboto-black"></span>, autorizo a <span id="textAgent" class="roboto-black"></span> de <span class="roboto-black" id="textCarrier">Lapeira & Associates LLC</span> para servir como mi agente y broker de seguros de salud, es decir mi Agente de Registro, para mi y las personas en mi núcleo familiar, cuando aplica, para el propósito de enrolamiento en un Plan Médico Calificado ofrecido en el Mercado de Salud Federal.</p>
                    <p class="mb-3 roboto-black" id="authorizationText"></p>
                    <p class="roboto-light">Al firmar esta forma, autorizo a <span class="roboto-black" id="textAgent2"></span>, y su staff, a trabajar para mi y las personas en mi núcleo familiar, cuando aplica, en las siguientes funciones de apoyo de seguro y cualquier otra tarea administrativa necesaria para mantener mi solicitud y cobertura en buen estado, como sigue:</p>
                    <ol class="roboto-light">
                        <li>Realizar búsquedas de aplicaciones nuevas o actuales en el mercado de salud.</li>
                        <li>Completar una aplicación para búsqueda de eligibilidad y enrolamiento en el Mercado de Salud Federal, o en programas de gobierno tales como Medicaid y CHIP, en los sitios de Enrolamiento Directo del Mercado de Salud, o enrolamiento en programas del mercado de salud que ayudan a aplicar a crédito fiscales o enrolamiento de productos de seguros en planes a nivel estatal.</li>
                        <li>Proveer mantenimiento de mi cuenta en el Mercado de Salud Federal, asistencia en enrolamiento, información sobre los beneficios de los planes, nuevos productos, beneficios de nuevos productos, y asesoría en los pagos de transacciones si es necesario.</li>
                        <li>Apoyar si es necesario en responder inquietudes del Mercado de Salud Federal en lo referente a mi aplicación.</li>
                        <li>Consentimiento de comunicación (Cumplimiento TCPA): Yo, <span id="textName2" class="roboto-black"></span> , doy mi consentimiento para recibir comunicaciones de <span class="roboto-black" id="textCarrier3">Lapeira & Associates LLC</span> con respecto a opciones de seguro de salud, beneficios, productos de seguros, actualizaciones de pólizas, primas, solicitudes y asuntos relacionados a través de llamadas telefónicas, correos electrónicos, mensajes SMS y otras formas de comunicación para ayudarme o recordarme cualquier acción necesaria para mantener mi póliza en buen estado. Entiendo que dichas comunicaciones pueden involucrar el uso de sistemas automatizados o mensajes de voz pregrabados de <span class="roboto-black" id="textCarrier4">Lapeira & Associates LLC</span> en el número proporcionado. Al proporcionar mi información de contacto con mi firma electrónica, cuando hago clic en el botón "enviar", acepto los Términos de Uso de <span class="roboto-black" id="textCarrier5">Lapeira & Associates LLC</span>  . Este consentimiento incluye aceptar resolver cualquier reclamo de la Ley de Protección al Consumidor de Teléfonos mediante arbitraje. Esto aplica incluso si su número está en una lista de no llamar. Aceptar estas llamadas o textos no es un requisito para comprar bienes o servicios de nosotros. Al recibir un mensaje de texto, puede responder <span class="roboto-black">SI</span> para recibir actualizaciones e información sobre su póliza de <span class="roboto-black" id="textCarrier6">Lapeira & Associates LLC</span> También puede responder <span class="roboto-black">AYUDA</span> para obtener ayuda. Pueden aplicarse tarifas de mensajes y datos. Hasta 5 mensajes/mes. Responda <span class="roboto-black">ALTO</span> para cancelar en cualquier momento. Para obtener más información sobre nuestras Políticas de Privacidad, haga clic aquí: <a href="https://lapeirainsurance.com/privacy-policy/">https://lapeirainsurance.com/privacy-policy/</a>. Para obtener más información sobre nuestros Términos de Uso, haga clic aquí: <a href="https://lapeirainsurance.com/terms-of-use/">https://lapeirainsurance.com/terms-of-use/</a>.
                        </li>
                    </ol>
                    <p class="roboto-light">Entiendo que mi Agente de Registro no utilizará o compartirá mi información de identificación personal (PII) para ningún propósito excepto los aquí listados en esta autorización. Entiendo que esta autorización será válida hasta que sea revocada por mi en cualquier momento. Para revocar esta autorización, debo hacerlo por escrito y enviarlo a la persona correspondiente a través del correo electrónico: client@lapeira.com.</p>
                    <p class="roboto-light">Entiendo que la información que yo le suministre a mi Agente de Registro se va a utilizar ÚNICAMENTE para asistirme en verificar mi elegibilidad y mi aplicacion o enrolamiento en el mercado de salud federal (Marketplace). Esta aprobación incluye la búsqueda de una aplicacion activa utilizando la páginas web aprobadas para el enrolamiento clásico directo (DE) o el Enhanced Direct Enrollment (EDE). Así mismo, entiendo que no tengo que compatir otra informacion adicional excepto la que es requerida para mi enrolamiento o verificacion de eligibilidad en el mercado de salud federal (Marketplace)</p>
                    <span class="roboto-black">Reconocimiento de Información Correcta y No Falsificación</span><br>
                    <p class="roboto-light">Al firmar este formulario, afirmo y reconozco que he sido completamente informado y se me ha brindado una explicación clara sobre lo siguiente:</p>
                    <ol class="roboto-light">
                        <li>Los beneficios específicos incluidos en el plan de salud, incluyendo cualquier cobertura de seguro o beneficios asociados.</li>
                        <li>Si el plan de salud en el que me estoy inscribiendo es considerado un plan de salud mayor o integral, o si es equivalente a dicha cobertura de seguro.</li>
                        <li>Los costos verdaderos y precisos asociados con el plan de salud, incluyendo primas, deducibles y otras obligaciones financieras.</li>
                    </ol>
                    <p class="roboto-light">Además, confirmo que no se me ha ofrecido ni prometido ningún tipo de ofertas gratuitas, recompensas en efectivo, reembolsos u otros incentivos relacionados con la inscripción en el plan de salud. Reconozco que no se me ha hecho ninguna afirmación o promesa sobre este tipo de incentivos durante el proceso de inscripción.</p>
                    <span class="roboto-black">Certificación de Revisión y Reconocimiento de la Información</span><br>
                    <p class="roboto-light">Yo, <span id="textName3" class="roboto-black"></span>, he revisado y confirmado que la información para mi aplicación en el mercado de salud es CORRECTA Y VERIDICA y estará disponible como es requerido por el Centro de Servicios de Medicare & Medicaid (CMS) para efectos de elegibilidad y enrolamiento.</p> 
                    <p class="roboto-light">Nombre del Agente en Registro: <span class="roboto-black" id="textAgent3"></span><br>
                        Nombre de la Agencia en Registro: <span class="roboto-black" id="textCarrier7">Lapeira & Associates LLC</span><br>
                        Teléfono de la Agencia: <span class="roboto-black">+1 (855) 963 6900</span>
                    </p>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="bg-orange p-3 rounded mb-3 row m-1">
                <div class="col-12">
                    <label class="form-label">Firma Aplicante o Representante Autorizado<span class="text-danger">*</span></label>
                </div>
                <div class="col-12 container-fluid">
                    <canvas width="330px" height="150px" id="drawingCanvas" class="signature-pad"></canvas>
                    <input type="hidden" id="signatureInput" name="signature">
                </div>
                <button type="button" id="clearCanvas" class="btn btn-secondary btn-sm">Limpiar firma</button>
            </div>            

            <!-- Form Buttons -->
            <div class="row">
                <div class="row row-cols-auto g-3">
                    <div class="col mb-3">
                        <button id="submitButton" class="btn btn-outline-primary ps-4 pe-4">Enviar</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>


    <script>
        // Variables globales
let canvas, ctx, isDrawing = false;

// Inicializar cuando el DOM esté cargado
document.addEventListener('DOMContentLoaded', function() {
    initSignaturePad();
    initFormEvents();
    updateDynamicText();
    initFileUpload();
});

// Inicializar pad de firma
function initSignaturePad() {
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    
    // Configurar el canvas
    canvas.width = 330;
    canvas.height = 150;
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    // Eventos de mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Eventos táctiles
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Botón limpiar
    document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
}

function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                    e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    canvas.dispatchEvent(mouseEvent);
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Actualizar texto dinámico en tiempo real
function updateDynamicText() {
    const firstName = document.getElementById('inputName').value || '[Nombre]';
    const lastName = document.getElementById('inputLastName').value || '[Apellido]';
    const agent = document.getElementById('selectAgent').value !== 'no_valid' ? 
                 document.getElementById('selectAgent').value : '[Agente]';
    
    const fullName = `${firstName} ${lastName}`;
    
    // Actualizar todos los spans dinámicos
    document.getElementById('textName').textContent = fullName;
    document.getElementById('textName2').textContent = fullName;
    document.getElementById('textName3').textContent = fullName;
    document.getElementById('textAgent').textContent = agent;
    document.getElementById('textAgent2').textContent = agent;
    document.getElementById('textAgent3').textContent = agent;
}

// Inicializar eventos del formulario
function initFormEvents() {
    // Actualizar texto dinámico cuando cambien los campos
    document.getElementById('inputName').addEventListener('input', updateDynamicText);
    document.getElementById('inputLastName').addEventListener('input', updateDynamicText);
    document.getElementById('selectAgent').addEventListener('change', updateDynamicText);

    // Evento principal del formulario
    document.getElementById('submitButton').addEventListener('click', handleSubmit);

    // Validación de teléfono
    document.getElementById('inputPhone').addEventListener('input', validatePhone);
    
    // Validación de email
    document.getElementById('inputEmail').addEventListener('input', validateEmail);
}

// Manejar el envío del formulario
async function handleSubmit(e) {
    e.preventDefault();
    
    if (!validateForm()) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Por favor complete todos los campos requeridos correctamente.'
        });
        return;
    }

    try {
        // Mostrar loading
        Swal.fire({
            title: 'Procesando...',
            text: 'Generando PDF y enviando por correo. Esto puede tomar unos momentos...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        console.log('Iniciando proceso de envío...');

        // Generar PDF
        console.log('Generando PDF...');
        const pdfBlob = await generatePDFBlob();
        console.log('PDF generado correctamente');
        
        // Enviar por correo
        console.log('Enviando por correo...');
        const result = await sendPDFByEmail(pdfBlob);
        console.log('Enviado correctamente:', result);

        Swal.fire({
            icon: 'success',
            title: '¡Éxito!',
            text: 'El formulario ha sido enviado correctamente por correo electrónico.',
            showConfirmButton: true
        });

    } catch (error) {
        console.error('Error completo:', error);
        
        let errorMessage = 'Hubo un problema al procesar el formulario.';
        
        if (error.message.includes('Timeout') || error.message.includes('timeout')) {
            errorMessage = 'La operación tardó demasiado tiempo. Verifique la configuración del servidor de correo.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `${errorMessage} Por favor intente nuevamente.`,
            showConfirmButton: true
        });
    }
}

// Generar PDF y devolver como Blob
async function generatePDFBlob() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configurar fuente
    doc.setFont('helvetica');
    
    let yPosition = 20;
    const lineHeight = 6;
    const margin = 20;
    const pageWidth = doc.internal.pageSize.width;
    const maxWidth = pageWidth - (margin * 2);

    // Título
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('AGENTE EN REGISTRO', pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 10;
    
    doc.setFontSize(12);
    doc.text('AUTORIZACIÓN DE ENTREGA INFORMACIÓN PARA ENROLAMIENTO EN EL MERCADO DE SALUD', 
            pageWidth / 2, yPosition, { align: 'center' });
    yPosition += 15;

    // Función para añadir texto con salto de línea
    function addText(text, fontSize = 10, isBold = false) {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', isBold ? 'bold' : 'normal');
        
        const lines = doc.splitTextToSize(text, maxWidth);
        lines.forEach(line => {
            if (yPosition > 280) {
                doc.addPage();
                yPosition = 20;
            }
            doc.text(line, margin, yPosition);
            yPosition += lineHeight;
        });
        yPosition += 2;
    }

    // Obtener datos del formulario
    const formData = getFormData();
    
    // Información personal
    addText('INFORMACIÓN PERSONAL', 12, true);
    addText(`Nombre: ${formData.firstName} ${formData.lastName}`);
    addText(`Teléfono: ${formData.phone}`);
    addText(`Email: ${formData.email}`);
    addText(`Fecha de Nacimiento: ${formData.dateBirth}`);
    addText(`Dirección: ${formData.address}`);
    if (formData.apto) addText(`Apartamento: ${formData.apto}`);
    addText(`Ciudad: ${formData.city}, Estado: ${formData.state}, ZIP: ${formData.zipcode}`);
    yPosition += 5;

    // Información adicional
    addText('INFORMACIÓN ADICIONAL', 12, true);
    addText(`Aplica: ${formData.apply}`);
    addText(`Ingreso Anual: $${formData.taxes}`);
    addText(`Tipo de Ingreso: ${formData.work}`);
    addText(`Estatus Migratorio: ${formData.migrationStatus}`);
    addText(`Social Security: ${formData.ssn || 'No proporcionado'}`);
    addText(`Agente: ${formData.agent}`);
    yPosition += 5;

    // Métodos de contacto
    addText('MÉTODOS DE CONTACTO AUTORIZADOS', 12, true);
    const contactMethods = [];
    if (formData.contactPhone) contactMethods.push('Teléfono');
    if (formData.contactSMS) contactMethods.push('SMS');
    if (formData.contactEmail) contactMethods.push('Email');
    if (formData.contactWhatsapp) contactMethods.push('WhatsApp');
    addText(`Autoriza contacto por: ${contactMethods.join(', ')}`);
    yPosition += 5;

    // Aplicantes adicionales
    if (formData.additionalApplicants) {
        addText('APLICANTES ADICIONALES', 12, true);
        addText(formData.additionalApplicants);
        yPosition += 5;
    }

    // Derechos y autorización (texto completo)
    addText('MIS DERECHOS COMO PACIENTE', 12, true);
    
    // Párrafo 1
    addText(`Yo, ${formData.firstName} ${formData.lastName}, autorizo a ${formData.agent} de Lapeira & Associates LLC para servir como mi agente y broker de seguros de salud, es decir mi Agente de Registro, para mi y las personas en mi núcleo familiar, cuando aplica, para el propósito de enrolamiento en un Plan Médico Calificado ofrecido en el Mercado de Salud Federal.`);
    
    // Párrafo 2
    addText(`Al firmar esta forma, autorizo a ${formData.agent}, y su staff, a trabajar para mi y las personas en mi núcleo familiar, cuando aplica, en las siguientes funciones de apoyo de seguro y cualquier otra tarea administrativa necesaria para mantener mi solicitud y cobertura en buen estado, como sigue:`);
    
    // Lista numerada
    addText('1. Realizar búsquedas de aplicaciones nuevas o actuales en el mercado de salud.');
    addText('2. Completar una aplicación para búsqueda de eligibilidad y enrolamiento en el Mercado de Salud Federal, o en programas de gobierno tales como Medicaid y CHIP, en los sitios de Enrolamiento Directo del Mercado de Salud, o enrolamiento en programas del mercado de salud que ayudan a aplicar a crédito fiscales o enrolamiento de productos de seguros en planes a nivel estatal.');
    addText('3. Proveer mantenimiento de mi cuenta en el Mercado de Salud Federal, asistencia en enrolamiento, información sobre los beneficios de los planes, nuevos productos, beneficios de nuevos productos, y asesoría en los pagos de transacciones si es necesario.');
    addText('4. Apoyar si es necesario en responder inquietudes del Mercado de Salud Federal en lo referente a mi aplicación.');
    addText(`5. Consentimiento de comunicación (Cumplimiento TCPA): Yo, ${formData.firstName} ${formData.lastName}, doy mi consentimiento para recibir comunicaciones de Lapeira & Associates LLC con respecto a opciones de seguro de salud, beneficios, productos de seguros, actualizaciones de pólizas, primas, solicitudes y asuntos relacionados a través de llamadas telefónicas, correos electrónicos, mensajes SMS y otras formas de comunicación para ayudarme o recordarme cualquier acción necesaria para mantener mi póliza en buen estado. Entiendo que dichas comunicaciones pueden involucrar el uso de sistemas automatizados o mensajes de voz pregrabados de Lapeira & Associates LLC en el número proporcionado. Al proporcionar mi información de contacto con mi firma electrónica, cuando hago clic en el botón "enviar", acepto los Términos de Uso de Lapeira & Associates LLC. Este consentimiento incluye aceptar resolver cualquier reclamo de la Ley de Protección al Consumidor de Teléfonos mediante arbitraje. Esto aplica incluso si su número está en una lista de no llamar. Aceptar estas llamadas o textos no es un requisito para comprar bienes o servicios de nosotros. Al recibir un mensaje de texto, puede responder SI para recibir actualizaciones e información sobre su póliza de Lapeira & Associates LLC También puede responder AYUDA para obtener ayuda. Pueden aplicarse tarifas de mensajes y datos. Hasta 5 mensajes/mes. Responda ALTO para cancelar en cualquier momento. Para obtener más información sobre nuestras Políticas de Privacidad, haga clic aquí: https://lapeirainsurance.com/privacy-policy/. Para obtener más información sobre nuestros Términos de Uso, haga clic aquí: https://lapeirainsurance.com/terms-of-use/.`);
    
    yPosition += 3;
    
    // Párrafos adicionales
    addText('Entiendo que mi Agente de Registro no utilizará o compartirá mi información de identificación personal (PII) para ningún propósito excepto los aquí listados en esta autorización. Entiendo que esta autorización será válida hasta que sea revocada por mi en cualquier momento. Para revocar esta autorización, debo hacerlo por escrito y enviarlo a la persona correspondiente a través del correo electrónico: client@lapeira.com.');
    
    addText('Entiendo que la información que yo le suministre a mi Agente de Registro se va a utilizar ÚNICAMENTE para asistirme en verificar mi elegibilidad y mi aplicacion o enrolamiento en el mercado de salud federal (Marketplace). Esta aprobación incluye la búsqueda de una aplicacion activa utilizando la páginas web aprobadas para el enrolamiento clásico directo (DE) o el Enhanced Direct Enrollment (EDE). Así mismo, entiendo que no tengo que compatir otra informacion adicional excepto la que es requerida para mi enrolamiento o verificacion de eligibilidad en el mercado de salud federal (Marketplace)');
    
    yPosition += 3;
    
    // Reconocimiento de Información Correcta
    addText('RECONOCIMIENTO DE INFORMACIÓN CORRECTA Y NO FALSIFICACIÓN', 11, true);
    addText('Al firmar este formulario, afirmo y reconozco que he sido completamente informado y se me ha brindado una explicación clara sobre lo siguiente:');
    addText('1. Los beneficios específicos incluidos en el plan de salud, incluyendo cualquier cobertura de seguro o beneficios asociados.');
    addText('2. Si el plan de salud en el que me estoy inscribiendo es considerado un plan de salud mayor o integral, o si es equivalente a dicha cobertura de seguro.');
    addText('3. Los costos verdaderos y precisos asociados con el plan de salud, incluyendo primas, deducibles y otras obligaciones financieras.');
    
    addText('Además, confirmo que no se me ha ofrecido ni prometido ningún tipo de ofertas gratuitas, recompensas en efectivo, reembolsos u otros incentivos relacionados con la inscripción en el plan de salud. Reconozco que no se me ha hecho ninguna afirmación o promesa sobre este tipo de incentivos durante el proceso de inscripción.');
    
    yPosition += 3;
    
    // Certificación de Revisión
    addText('CERTIFICACIÓN DE REVISIÓN Y RECONOCIMIENTO DE LA INFORMACIÓN', 11, true);
    addText(`Yo, ${formData.firstName} ${formData.lastName}, he revisado y confirmado que la información para mi aplicación en el mercado de salud es CORRECTA Y VERIDICA y estará disponible como es requerido por el Centro de Servicios de Medicare & Medicaid (CMS) para efectos de elegibilidad y enrolamiento.`);
    
    addText(`Nombre del Agente en Registro: ${formData.agent}`);
    addText('Nombre de la Agencia en Registro: Lapeira & Associates LLC');
    addText('Teléfono de la Agencia: +1 (855) 963 6900');
    
    yPosition += 5;

    // Firma
    if (canvas && !isCanvasEmpty()) {
        addText('FIRMA DIGITAL', 12, true);
        const signatureData = canvas.toDataURL('image/png');
        doc.addImage(signatureData, 'PNG', margin, yPosition, 80, 30);
        yPosition += 35;
    }

    addText(`Fecha: ${new Date().toLocaleDateString()}`);
    addText(`Firmado por: ${formData.firstName} ${formData.lastName}`);

    return doc.output('blob');
}

// Enviar PDF por correo
// Enviar PDF por correo con timeout
async function sendPDFByEmail(pdfBlob) {
    const formData = new FormData();
    const userData = getFormData();
    
    // Agregar el PDF
    formData.append('pdf_file', pdfBlob, `Consentimiento_${userData.firstName}_${userData.lastName}.pdf`);
    
    // Agregar datos del formulario
    formData.append('first_name', userData.firstName);
    formData.append('last_name', userData.lastName);
    formData.append('phone', userData.phone);
    formData.append('agent', userData.agent);

    try {
        console.log('Enviando formulario...'); // Para debug
        
        // Crear un controller para poder cancelar la petición si es necesario
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segundos timeout
        
        // Enviar a Django backend
        const response = await fetch('/sendConsentForm/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            signal: controller.signal
        });

        clearTimeout(timeoutId);
        console.log('Respuesta recibida:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => null);
            const errorMessage = errorData?.error || `Error HTTP: ${response.status}`;
            console.error('Error en respuesta:', errorMessage);
            throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('Resultado:', result);
        return result;

    } catch (error) {
        if (error.name === 'AbortError') {
            console.error('Timeout en la petición');
            throw new Error('La operación tardó demasiado tiempo. Verifique su conexión a internet.');
        }
        console.error('Error en sendPDFByEmail:', error);
        throw error;
    }
}

// Función mejorada para manejar el envío del formulario
async function handleSubmit(e) {
    e.preventDefault();
    
    if (!validateForm()) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Por favor complete todos los campos requeridos correctamente.'
        });
        return;
    }

    try {
        // Mostrar loading
        Swal.fire({
            title: 'Procesando...',
            text: 'Generando PDF y enviando por correo',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        console.log('Iniciando proceso de envío...');

        // Generar PDF
        console.log('Generando PDF...');
        const pdfBlob = await generatePDFBlob();
        console.log('PDF generado correctamente');
        
        // Enviar por correo
        console.log('Enviando por correo...');
        const result = await sendPDFByEmail(pdfBlob);
        console.log('Enviado correctamente:', result);

        Swal.fire({
            icon: 'success',
            title: 'Formulario enviado correctamente',
            text: 'Gracias por enviar el consentimiento.',
            timer: 5000,
            timerProgressBar: true,
            confirmButtonText: 'OK',
            allowOutsideClick: false,
            allowEscapeKey: false,
            willClose: () => {
                // Esto se ejecuta si el usuario no hace clic y se cierra por el temporizador
                location.reload();
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Esto se ejecuta si el usuario hace clic en "OK"
                location.reload();
            }
        });

    } catch (error) {
        console.error('Error completo:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: `Hubo un problema al procesar el formulario: ${error.message}. Por favor intente nuevamente.`
        });
    }
}

// Función mejorada para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // Si no encuentra el token, intentar obtenerlo del meta tag
    if (!cookieValue) {
        const metaTag = document.querySelector('[name=csrf-token]');
        if (metaTag) {
            cookieValue = metaTag.getAttribute('content');
        }
    }
    
    console.log('CSRF Token:', cookieValue); // Para debug
    return cookieValue;
}


// Obtener datos del formulario
function getFormData() {
    return {
        firstName: document.getElementById('inputName').value,
        lastName: document.getElementById('inputLastName').value,
        phone: document.getElementById('inputPhone').value,
        email: document.getElementById('inputEmail').value,
        dateBirth: document.getElementById('inputDateBirth').value,
        address: document.getElementById('inputAddress').value,
        apto: document.getElementById('inputApto').value,
        city: document.getElementById('inputCity').value,
        state: document.getElementById('inputState').value,
        zipcode: document.getElementById('inputZipcode').value,
        apply: document.getElementById('apply').value,
        taxes: document.getElementById('inputTaxes').value,
        work: document.getElementById('work').value,
        migrationStatus: document.getElementById('migration_status').value,
        ssn: document.getElementById('inputSSN').value,
        agent: document.getElementById('selectAgent').value,
        additionalApplicants: document.getElementById('inputApplicants').value,
        contactPhone: document.getElementById('Telefono').checked,
        contactSMS: document.getElementById('Sms').checked,
        contactEmail: document.getElementById('Emails').checked,
        contactWhatsapp: document.getElementById('Whatsapp').checked
    };
}

// Validar formulario
function validateForm() {
    const requiredFields = [
        'inputName', 'inputLastName', 'inputPhone', 'inputDateBirth',
        'inputTaxes', 'selectAgent'
    ];

    for (let fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value || field.value === 'no_valid') {
            field.focus();
            return false;
        }
    }

    // Validar que al menos un método de contacto esté seleccionado
    const contactMethods = document.querySelectorAll('.contactMethod');
    const hasContactMethod = Array.from(contactMethods).some(method => method.checked);
    
    if (!hasContactMethod) {
        Swal.fire({
            icon: 'warning',
            title: 'Método de contacto requerido',
            text: 'Por favor seleccione al menos un método de contacto.'
        });
        return false;
    }

    // Validar firma
    if (isCanvasEmpty()) {
        Swal.fire({
            icon: 'warning',
            title: 'Firma requerida',
            text: 'Por favor proporcione su firma digital.'
        });
        return false;
    }

    return true;
}

// Verificar si el canvas está vacío
function isCanvasEmpty() {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}


// Validaciones
function validatePhone() {
    const phone = document.getElementById('inputPhone').value;
    const error = document.getElementById('error');
    
    if (phone && (phone.length < 10 || phone.length > 11)) {
        error.style.display = 'block';
        return false;
    } else {
        error.style.display = 'none';
        return true;
    }
}

function validateEmail() {
    const email = document.getElementById('inputEmail').value;
    const error = document.getElementById('errorEmail');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        error.style.display = 'block';
        return false;
    } else {
        error.style.display = 'none';
        return true;
    }
}

// Obtener cookie CSRF para Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializar manejo de archivos
function initFileUpload() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');

    // Prevenir comportamiento por defecto
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Destacar dropzone cuando se arrastra sobre él
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, unhighlight, false);
    });

    // Manejar archivos soltados
    dropzone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight() {
        dropzone.classList.add('bg-primary', 'bg-opacity-10');
    }

    function unhighlight() {
        dropzone.classList.remove('bg-primary', 'bg-opacity-10');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        fileList.innerHTML = '';
        Array.from(files).forEach(file => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>
                    <i class="bi bi-file-earmark"></i>
                    ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                </span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            fileList.appendChild(li);
        });
    }
}
    </script>


</body>
</html>