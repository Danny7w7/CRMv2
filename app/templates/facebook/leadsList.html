{% extends "dashboard/index.html" %}
{% load static %}
{% block head %}
    <title>Leads de Facebook</title>
	<!--plugins-->
	<link href="{% static "assets/plugins/simplebar/css/simplebar.css" %}" rel="stylesheet" />
	<link href="{% static "assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" %}" rel="stylesheet" />
	<link href="{% static "assets/plugins/metismenu/css/metisMenu.min.css" %}" rel="stylesheet" />
	<link href="{% static "assets/plugins/datatable/css/dataTables.bootstrap5.min.css" %}" rel="stylesheet" />
	<!-- loader-->
	<link href="{% static "assets/css/pace.min.css" %}" rel="stylesheet" />
	<script src="{% static "assets/js/pace.min.js" %}"></script>
	<!-- Bootstrap CSS -->
	<link href="{% static "assets/css/bootstrap.min.css" %}" rel="stylesheet">
	<link href="{% static "assets/css/bootstrap-extended.css" %}" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&amp;display=swap" rel="stylesheet">
	<link href="{% static "assets/css/app.css" %}" rel="stylesheet">
	<link href="{% static "assets/css/icons.css" %}" rel="stylesheet">
	<!-- Theme Style CSS -->
	<link rel="stylesheet" href="{% static "assets/css/dark-theme.css" %}" />
	<link rel="stylesheet" href="{% static "assets/css/semi-dark.css" %}" />
	<link rel="stylesheet" href="{% static "assets/css/header-colors.css" %}" />
	
	<style>
		.lead-preview {
			max-width: 300px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			color: #666;
			font-size: 14px;
		}
		
		.empty-state {
			padding: 60px 20px;
			text-align: center;
		}
		
		.empty-state-icon {
			font-size: 64px;
			opacity: 0.3;
			margin-bottom: 20px;
		}
		
		.filter-card {
			margin-bottom: 20px;
		}
	</style>
{% endblock %}

{% block page_content %}
<!-- Header -->
<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
    
	<div class="breadcrumb-title pe-3">
		<i class='bx bxs-envelope me-2'></i>
		Leads de Facebook
	</div>

</div>

<br>

<h6 class="mb-0 text-uppercase">Search filters</h6>
<hr/>

<!-- Filtros -->
<div class="card filter-card">
	<div class="card-body">
		<form method="POST">
			{% csrf_token %}
			<div class="row g-3">
				<div class="col-md-3">
					<label class="form-label">Facebook Page</label>
					<select name="account" class="form-select" required>
						<option selected disabled >Select please</option>
						<option value="">All pages</option>
						{% for account in accounts %}
						<option value="{{ account.id }}" {% if selected_account == account.id|stringformat:"s" %}selected{% endif %}>
							{{ account.page_name }}
						</option>
						{% endfor %}
					</select>
				</div>
				
				<div class="col-md-3">
					<label class="form-label">Status</label>
					<select name="status" class="form-select" required>
						<option selected disabled >Select please</option>
						<option value="">All</option>
						<option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pendientes</option>
						<option value="processed" {% if selected_status == 'processed' %}selected{% endif %}>Procesados</option>
					</select>
				</div>
				
				
				<div class="col-md-2 d-flex align-items-end">
					<button type="submit" class="btn btn-primary w-100">
						<i class='bx bx-search-alt'></i> Apply filters
					</button>
				</div>
			</div>
		</form>
	</div>
</div>

<h6 class="mb-0 text-uppercase">Leads List</h6>
<hr/>

<!-- Tabla de Leads -->
<div class="card">
	<div class="card-body">
		{% if leads %}
		<div class="table-responsive">
			<table id="leadsTable" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>ID</th>
						<th>Facebook Page</th>
						<th>Date</th>
						<th>Preview</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for lead in leads %}
					<tr>
						<td>
							<span class="badge bg-secondary">{{ lead.leadgen_id|slice:":8" }}...</span>
						</td>
						<td>
							<div class="d-flex align-items-center">
								<div class="ms-2">
									<h6 class="mb-0 font-14">{{ lead.facebook_account.page_name }}</h6>
								</div>
							</div>
						</td>
						<td>
							<span class="text-secondary">{{ lead.created_time|date:"d/m/Y" }}</span><br>
							<small class="text-muted">{{ lead.created_time|date:"H:i" }}</small>
						</td>
						<td>
							<div class="lead-preview">
								{% if lead.raw_payload.field_data %}
									{% for field in lead.raw_payload.field_data|slice:":2" %}
										<strong>{{ field.name }}:</strong> {{ field.values.0 }}{% if not forloop.last %}<br>{% endif %}
									{% endfor %}
								{% else %}
									<span class="text-muted">No data available</span>
								{% endif %}
							</div>
						</td>
						<td>
							{% if lead.processed %}
							<span class="badge bg-success">
								<i class='bx bx-check'></i> Processed
							</span>
							{% else %}
							<span class="badge bg-warning text-dark">
								<i class='bx bx-time'></i> Pending
							</span>
							{% endif %}
						</td>
						<td>
							<div class="d-flex gap-2">
								<a href="/facebook/leads/{{ lead.id }}/" class="btn btn-primary btn-sm">
									<i class='bx bx-show'></i> View
								</a>
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>

			</table>
		</div>
		{% else %}
		<div class="empty-state">
			<div class="empty-state-icon">
				<i class='bx bx-envelope-open'></i>
			</div>
			<h4 class="text-secondary">No leads available yet</h4>
			<p class="text-muted">Leads will be displayed here automatically when they arrive from Facebook</p>
			<a href="/facebook/connect/" class="btn btn-primary mt-3">
				<i class='bx bx-plus'></i> Connect page
			</a>
		</div>
		{% endif %}
	</div>
</div>

{% endblock %}

{% block end_js %}
	<!-- Bootstrap JS -->
	<script src="{% static "assets/js/bootstrap.bundle.min.js" %}"></script>
	<!--plugins-->
	<script src="{% static "assets/js/jquery.min.js" %}"></script>
	<script src="{% static "assets/plugins/simplebar/js/simplebar.min.js" %}"></script>
	<script src="{% static "assets/plugins/metismenu/js/metisMenu.min.js" %}"></script>
	<script src="{% static "assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js" %}"></script>
	<script src="{% static "assets/plugins/datatable/js/jquery.dataTables.min.js" %}"></script>
	<script src="{% static "assets/plugins/datatable/js/dataTables.bootstrap5.min.js" %}"></script>
	<!--app JS-->
	<script src="{% static "assets/js/app.js" %}"></script>

	<script>
		$(document).ready(function() {
			// Inicializar DataTable si hay datos
			{% if leads %}
			$('#leadsTable').DataTable({
				"language": {
					"url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
				},
				"pageLength": 25,
				"order": [[2, "desc"]], // Ordenar por fecha descendente
				"columnDefs": [
					{ "orderable": false, "targets": [3, 5] } // Deshabilitar orden en vista previa y acciones
				]
			});
			{% endif %}
		});
	</script>
{% endblock %}